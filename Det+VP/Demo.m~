run ~/3rd_party_libs/vlfeat-0.9.19/toolbox/vl_setup
epflDatasetPath = '~/data/epfl-gims08/tripod-seq/';

% Get relevant data and feature info
carID = 8;  
[train, frames, times, w, h] = epflData( epflDatasetPath, carID, carID );
[featExtractor, cellSize, featDim, visualizer] = getFeatExtractor('imgrad');

N = 1.5;                % Stretching coefficient 
sigma = 8/cellSize;     % Parameter for importance filter

% Init descriptor
wFeat = floor(w/cellSize);
hFeat = floor(h/cellSize);
filterSize = floor((wFeat+1)/2);
W = floor(N*wFeat+filterSize);
H = hFeat;
repbroom  = zeros(H, W, featDim);

% Importance filter
g_x=fspecial('gaussian',[1 filterSize], sigma);
g_x = repmat(g_x, [hFeat, 1, featDim]);

for i = 1 : length(train)
    % Compute the stride based on the angle
    stride = floor(filterSize+N*wFeat*train{i}.angle/360) + 1;

    % Compute image-features
    im = imresize( imread(train{i}.im), [h nan] );
    feat = featExtractor(im);

    % Extract relevant segment, weight it according to filter and stitch
    seg = feat(:,floor(wFeat/2)+[-filterSize/2:filterSize/2-1],:).*g_x;
    repbroom(:, floor(wFeat/2)+stride+[-filterSize/2:filterSize/2-1],:) = ...
        repbroom(:, floor(wFeat/2)+stride+[-filterSize/2:filterSize/2-1],:)+seg;  
    
    % Visualize the construction
    figure(1), visualizer(repbroom);
    pause(.001);
end

result = repbroom(:, 
% figure(2), imshow(repbroom,[]);

